<aside class="sidebar-shell" [class.is-collapsed]="collapsed">
  <header class="sidebar-head">
    <button type="button" class="collapse-btn" (click)="toggleCollapse.emit()" [attr.aria-label]="collapsed ? 'Expand' : 'Collapse'">
      <span class="chev" [class.rot]="collapsed">‚ùÆ</span>
    </button>
    <span class="title" *ngIf="!collapsed">–§–∞–π–ª—ã</span>
    <button type="button" class="new-btn" *ngIf="!collapsed" (click)="addChild(null)">Ôºã</button>
  </header>

  <div class="tree-scroll">
    <ul class="tree" role="tree">
      @if (loading()) {
        <li class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</li>
      } @else {
        @for (n of tree(); track trackById($index, n)) {
          <li role="treeitem" [attr.aria-expanded]="isOpen(n)" class="node">
            <div class="row">
              <button class="twisty" (click)="toggle(n)">
                <span class="icon" [class.open]="isOpen(n)">‚ñ∏</span>
              </button>

              <button class="label" (click)="select(n)">{{ n.title }}</button>

              <div class="row-actions">
                <button class="icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å" (click)="addChild(n)">Ôºã</button>
                <button class="icon-btn" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" (click)="rename(n)">‚úé</button>
                <button class="icon-btn danger" title="–£–¥–∞–ª–∏—Ç—å" (click)="remove(n, null)">üóë</button>
              </div>
            </div>

            @if (isOpen(n)) {
              <ul role="group">
                @if (!n.children.length) {
                  <li class="empty">–ü—É—Å—Ç–æ</li>
                } @else {
                  <ng-container *ngTemplateOutlet="renderChildren; context: { $implicit: n }"></ng-container>
                }
              </ul>
            }
          </li>
        }
      }
    </ul>
  </div>

  <ng-template #renderChildren let-parent>
    @for (c of parent.children; track trackById($index, c)) {
      <li role="treeitem" [attr.aria-expanded]="isOpen(c)" class="node">
        <div class="row">
          <button class="twisty" (click)="toggle(c)">
            <span class="icon" [class.open]="isOpen(c)">‚ñ∏</span>
          </button>

          <button class="label" (click)="select(c)">{{ c.title }}</button>

          <div class="row-actions">
            <button class="icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å" (click)="addChild(c)">Ôºã</button>
            <button class="icon-btn" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" (click)="rename(c)">‚úé</button>
            <button class="icon-btn danger" title="–£–¥–∞–ª–∏—Ç—å" (click)="remove(c, parent)">üóë</button>
          </div>
        </div>

        @if (isOpen(c)) {
          <ul role="group">
            @if (!c.children?.length) {
              <li class="empty">–ü—É—Å—Ç–æ</li>
            } @else {
              <ng-container *ngTemplateOutlet="renderChildren; context: { $implicit: c }"></ng-container>
            }
          </ul>
        }
      </li>
    }
  </ng-template>
</aside>
