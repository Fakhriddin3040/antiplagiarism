<div class="grid-header">
  <h2>{{ config.title }}</h2>
  <span class="spacer"></span>
  <button mat-flat-button color="primary" (click)="openCreateModal()">Создать</button>
</div>

<!-- Фильтры -->
<form [formGroup]="filterForm" class="filters" (ngSubmit)="$event.preventDefault()">
  <div class="filters-row" *ngFor="let f of config.filters">
    <div class="filter-item">
      <label class="filter-label">{{ f.label }}</label>

      <!-- оператор -->
      <mat-form-field appearance="outline" class="op">
        <mat-select [formControlName]="f.key + '__op'">
          <mat-option *ngFor="let op of f.operators" [value]="op">{{ op }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- значение -->
      <ng-container [ngSwitch]="f.type">
        <!-- text -->
        <mat-form-field *ngSwitchCase="'text'" appearance="outline" class="val">
          <input matInput [formControlName]="f.key + '__value'" placeholder="Значение" />
        </mat-form-field>

        <!-- number -->
        <mat-form-field *ngSwitchCase="'number'" appearance="outline" class="val">
          <input matInput type="number" [formControlName]="f.key + '__value'" placeholder="Значение" />
        </mat-form-field>

        <!-- boolean -->
        <mat-form-field *ngSwitchCase="'boolean'" appearance="outline" class="val">
          <mat-select [formControlName]="f.key + '__value'">
            <mat-option [value]="true">Да</mat-option>
            <mat-option [value]="false">Нет</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- select -->
        <mat-form-field *ngSwitchCase="'select'" appearance="outline" class="val">
          <mat-select [formControlName]="f.key + '__value'">
            <mat-option *ngFor="let o of ([])" [value]="o.value">{{ o.label }}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- multiselect -->
        <mat-form-field *ngSwitchCase="'multiselect'" appearance="outline" class="val">
          <mat-select [formControlName]="f.key + '__value'" multiple>
            <mat-option *ngFor="let o of ([])" [value]="o.value">{{ o.label }}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- date -->
        <mat-form-field *ngSwitchCase="'date'" appearance="outline" class="val">
          <input matInput [matDatepicker]="dp_{{f.key}}" [formControlName]="f.key + '__value'" placeholder="Дата" />
          <mat-datepicker-toggle matSuffix [for]="dp_{{f.key}}"></mat-datepicker-toggle>
          <mat-datepicker #dp_{{f.key}}></mat-datepicker>
        </mat-form-field>

        <!-- daterange / between -->
        <div *ngSwitchCase="'daterange'" class="range">
          <mat-form-field appearance="outline">
            <input matInput [matDatepicker]="dp_from_{{f.key}}" [formControlName]="f.key + '__value'" placeholder="От" />
            <mat-datepicker-toggle matSuffix [for]="dp_from_{{f.key}}"></mat-datepicker-toggle>
            <mat-datepicker #dp_from_{{f.key}}></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <input matInput [matDatepicker]="dp_to_{{f.key}}" [formControlName]="f.key + '__value2'" placeholder="До" />
            <mat-datepicker-toggle matSuffix [for]="dp_to_{{f.key}}"></mat-datepicker-toggle>
            <mat-datepicker #dp_to_{{f.key}}></mat-datepicker>
          </mat-form-field>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="filters-actions">
    <button mat-stroked-button type="button" (click)="filterForm.reset()">Сбросить</button>
    <button mat-flat-button color="primary" type="button" (click)="onPageChange(1)">Применить</button>
  </div>
</form>

<!-- Таблица -->
<div class="table-wrap" [class.loading]="loading()">
  <table mat-table [dataSource]="rows()">
    <!-- Динамические колонки -->
    <ng-container *ngFor="let col of config.columns" [matColumnDef]="col.key as string">
      <th mat-header-cell *matHeaderCellDef (click)="col.sortable && onSort(col.key as string)" [class.sortable]="col.sortable">
        {{ col.title }}
        <span class="sort-ind" *ngIf="sort()?.field === (col.key as string)">
          {{ sort()?.dir === 'asc' ? '▲' : '▼' }}
        </span>
      </th>
      <td mat-cell *matCellDef="let row">
        <ng-container *ngIf="col.cell; else plainCell">{{ col.cell!(row) }}</ng-container>
        <ng-template #plainCell>{{ (row as any)[col.key] }}</ng-template>
      </td>
    </ng-container>

    <!-- Действия -->
    <ng-container matColumnDef="__actions">
      <th mat-header-cell *matHeaderCellDef class="actions-col">Действия</th>
      <td mat-cell *matCellDef="let row" class="actions-col">
        <button mat-icon-button color="primary" (click)="openUpdateModal(row)"><mat-icon>edit</mat-icon></button>
        <button mat-icon-button color="warn" (click)="deleteModal(row)"><mat-icon>delete</mat-icon></button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="(config.columns.map(c => c.key as string)).concat(['__actions'])"></tr>
    <tr mat-row *matRowDef="let row; columns: (config.columns.map(c => c.key as string)).concat(['__actions']); trackBy: trackById"></tr>
  </table>

  <div class="progress" *ngIf="loading()">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</div>

<!-- Пагинация -->
<div class="paginator">
  <mat-form-field appearance="outline">
    <mat-label>На странице</mat-label>
    <mat-select [value]="pageSize()" (selectionChange)="onPageSizeChange($event.value)">
      <mat-option [value]="10">10</mat-option>
      <mat-option [value]="20">20</mat-option>
      <mat-option [value]="50">50</mat-option>
      <mat-option [value]="100">100</mat-option>
    </mat-select>
  </mat-form-field>

  <span class="total">Всего: {{ total() }}</span>

  <div class="pager-buttons">
    <button mat-stroked-button (click)="onPageChange(page() - 1)" [disabled]="page() <= 1">Назад</button>
    <span class="page">{{ page() }}</span>
    <button mat-stroked-button (click)="onPageChange(page() + 1)" [disabled]="page() * pageSize() >= total()">Вперёд</button>
  </div>
</div>
