<div class="ss">
  <div class="ss-input-wrap" [class.disabled]="disabled">
    <input #inputEl
           class="ss-input"
           [placeholder]="placeholder"
           [disabled]="disabled"
           role="combobox"
           aria-autocomplete="list"
           [attr.aria-expanded]="open()"
           [attr.aria-controls]="'ss-listbox'"
           [attr.aria-activedescendant]="open() && highlightIdx()>=0 ? 'ss-opt-' + highlightIdx() : null"
           [attr.aria-disabled]="disabled"
           autocomplete="off"
           autocapitalize="off"
           spellcheck="false"
           (focus)="focus()"
           (keydown)="onKeydown($event)"
           (input)="onInput($any($event.target).value)"
           (click)="hasQuery() ? fetch() : null" />

    @if (value()) {
      <button class="ss-clear" type="button" (click)="clear()" aria-label="Clear">✕</button>
    } @else {
      @if (loading()) {
        <div class="ss-spinner" aria-hidden="true"></div>
      }
    }
  </div>

  @if (open()) {
    <div class="ss-dropdown">
      @if (loading()) {
        <div class="ss-empty">Loading…</div>
      } @else if (!options().length) {
        <div class="ss-empty">No results</div>
      } @else {
        <ul class="ss-list" role="listbox" id="ss-listbox">
          @for (opt of options(); track trackById(i, opt); let i = $index) {
            <li class="ss-item"
                role="option"
                id="ss-opt-{{ i }}"
                [class.active]="i === highlightIdx()"
                [class.selected]="isSelected(opt)"
                [attr.aria-selected]="isSelected(opt)"
                (mouseenter)="highlightIdx.set(i)"
                (mousedown)="$event.preventDefault()"
                (click)="pick(opt)">
              @if (optionTpl) {
                <ng-container
                  [ngTemplateOutlet]="optionTpl"
                  [ngTemplateOutletContext]="{$implicit: opt, label: labelOf(opt), selected: isSelected(opt)}">
                </ng-container>
              } @else {
                {{ labelOf(opt) }}
              }
            </li>
          }
        </ul>
      }
    </div>
  }
</div>
