<form [formGroup]="form"
      (ngSubmit)="onSubmit()"
      class="dynamic-modal-form">

  <!-- ───── header ───── -->
  <div class="dynamic-modal-header">
    <h4 class="dynamic-modal-title">
      {{ data.mode === 'create' ? data.titleCreate : data.titleUpdate }}
    </h4>
  </div>

  <!-- ───── body ───── -->
  <div class="dynamic-modal-body">
    <div *ngFor="let field of data.formFieldSchema" class="mb-3">
      <label [for]="field.key">{{ field.label }}</label>

      <!-- единый ngSwitch -->
      <ng-container [ngSwitch]="field.type">

        <!-- стандартные поля -->
        <input *ngSwitchCase="'text'"
               class="form-control"
               [id]="field.key"
               type="text"
               [formControlName]="field.key">

        <textarea *ngSwitchCase="'textarea'"
                  class="form-control"
                  [id]="field.key"
                  [formControlName]="field.key"></textarea>

        <input *ngSwitchCase="'number'"
               class="form-control"
               [id]="field.key"
               type="number"
               [formControlName]="field.key">

        <select *ngSwitchCase="'select'"
                class="form-control"
                [id]="field.key"
                [formControlName]="field.key">
          <option *ngFor="let opt of field.options"
                  [value]="opt.value">
            {{ opt.label }}
          </option>
        </select>

        <div *ngSwitchCase="'checkbox'" class="form-check">
          <input class="form-check-input"
                 [id]="field.key"
                 type="checkbox"
                 [formControlName]="field.key">
        </div>

        <div *ngSwitchCase="'file-drop'">
          <label class="file-drop-cloud">
            <input type="file" (change)="onFileChange($event, field.key)"
                   class="file-input" />

            <div class="cloud-shape">
              <i class="cloud-icon">☁</i>
              <p class="cloud-text">
                Перетащите файл<br>
                <span class="muted">или кликните для выбора</span>
              </p>
            </div>
          </label>
        </div>

        <!-- ── AUTHOR SEARCH ── -->
        <div *ngSwitchCase="'author-search'"
             class="position-relative w-100">
          <input class="form-control"
                 type="text"
                 autocomplete="off"
                 [formControlName]="field.key"
                 (input)="onAuthorInput($event)"
                 (focus)="authorOpen = true"
                 (blur)="closeDropdownLater('author')">

          <div *ngIf="authorOpen && filteredAuthors.length"
               class="dropdown-list">
            <button *ngFor="let a of filteredAuthors"
                    type="button"
                    class="dropdown-item"
                    (mousedown)="selectAuthor(a)">
              {{ a.firstName }} {{ a.lastName }}
            </button>
          </div>
        </div>

        <!-- ── FOLDER SEARCH ── -->
        <div *ngSwitchCase="'folder-search'"
             class="position-relative w-100">
          <input class="form-control"
                 type="text"
                 autocomplete="off"
                 [formControlName]="field.key"
                 (input)="onFolderInput($event)"
                 (focus)="folderOpen = true"
                 (blur)="closeDropdownLater('folder')">

          <div *ngIf="folderOpen && filteredFolders.length"
               class="dropdown-list">
            <button *ngFor="let f of filteredFolders"
                    type="button"
                    class="dropdown-item"
                    (mousedown)="selectFolder(f)">
              {{ f.title }}
            </button>
          </div>
        </div>

      </ng-container>

      <!-- валидация -->
      <div *ngIf="form.get(field.key)!.invalid &&
                  (form.get(field.key)!.dirty || form.get(field.key)!.touched)"
           class="text-danger">
        {{ field.label }} is invalid
      </div>
    </div>
  </div>

  <!-- ───── footer ───── -->
  <div class="dynamic-modal-footer">
    <button type="button"
            class="btn btn-secondary"
            (click)="onCancel()">
      Закрыть
    </button>

    <button type="submit"
            class="btn btn-primary"
            [disabled]="form.invalid">
      {{ data.mode === 'create' ? data.submitLabelCreate : data.submitLabelUpdate }}
    </button>
  </div>
</form>
